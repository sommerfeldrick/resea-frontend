# üîê Integra√ß√£o SmileAI - Documenta√ß√£o Completa

## üìã Vis√£o Geral

Esta documenta√ß√£o descreve a integra√ß√£o completa do **Resea AI Research Assistant** com a plataforma **SmileAI** usando **Laravel Passport OAuth2**.

---

## üéØ Recursos Integrados

### Autentica√ß√£o OAuth2 (Laravel Passport)
- ‚úÖ Password Grant Flow (Login com email/senha)
- ‚úÖ Personal Access Token (Chamadas de API)
- ‚úÖ Refresh Token (Renova√ß√£o autom√°tica)
- ‚úÖ Token Validation (Valida√ß√£o de sess√£o)
- ‚úÖ Logout (Revoga√ß√£o de token)

### Funcionalidades SmileAI Dispon√≠veis
- ü§ñ **AI Chat** - Chat com IA
- ‚úçÔ∏è **AI Writer** - Gera√ß√£o de conte√∫do
- üé® **AI Image Generation** - Gera√ß√£o de imagens
- üìÑ **Documents** - Gerenciamento de documentos
- üéôÔ∏è **Brand Voice** - Personaliza√ß√£o de voz da marca
- üí¨ **Chat Templates** - Templates de conversa√ß√£o
- üë§ **User Profile** - Perfil do usu√°rio
- üí≥ **Payments** - Hist√≥rico de pagamentos
- ü§ù **Affiliates** - Programa de afiliados
- üÜò **Support** - Suporte ao cliente

---

## üèóÔ∏è Arquitetura

### Arquivos Criados/Modificados

```
backend/src/
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ oauth.ts                    ‚ú® NOVO - Configura√ß√£o OAuth SmileAI
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ smileaiAuth.ts              ‚ú® NOVO - Servi√ßo de autentica√ß√£o
‚îú‚îÄ‚îÄ middleware/
‚îÇ   ‚îî‚îÄ‚îÄ smileaiAuth.ts              ‚ú® NOVO - Middleware de autentica√ß√£o
‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îú‚îÄ‚îÄ auth.ts                     ‚ú® NOVO - Rotas de autentica√ß√£o
‚îÇ   ‚îî‚îÄ‚îÄ api.ts                      üìù MODIFICADO - Rotas principais
‚îî‚îÄ‚îÄ server.ts                       üìù MODIFICADO - Servidor Express
```

---

## üîß Configura√ß√£o

### 1. Vari√°veis de Ambiente

Adicione ao `backend/.env`:

```env
# SmileAI OAuth Configuration
MAIN_DOMAIN_API=https://smileai.com.br
OAUTH_CLIENT_ID=2
OAUTH_CLIENT_SECRET=2Moof1U6aYC1radoWP4ZozfMxPmy7Kufoyj2c7E8

# Frontend URL (para CORS)
FRONTEND_URL=https://app.smileai.com.br
```

### 2. Credenciais OAuth

As credenciais j√° est√£o configuradas no c√≥digo ([backend/src/config/oauth.ts](backend/src/config/oauth.ts:13)):

**Personal Access Client (ID: 1)**
- Client ID: `1`
- Client Secret: `Q2NM4Z6f4xt6HzlGhwRroO6eN5byqdjjmJoblJZX`
- Uso: Chamadas de API sem intera√ß√£o do usu√°rio

**Password Grant Client (ID: 2)** ‚≠ê RECOMENDADO
- Client ID: `2`
- Client Secret: `2Moof1U6aYC1radoWP4ZozfMxPmy7Kufoyj2c7E8`
- Uso: Login de usu√°rios com email/senha

---

## üì° API Endpoints

### Autentica√ß√£o

#### 1. Login (Password Grant)

```http
POST /api/auth/login
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "senha123"
}
```

**Response (200 OK):**
```json
{
  "success": true,
  "data": {
    "user": {
      "id": 1,
      "name": "Jo√£o Silva",
      "email": "user@example.com",
      "created_at": "2024-01-01T00:00:00.000Z"
    },
    "token": {
      "token_type": "Bearer",
      "expires_in": 31536000,
      "access_token": "eyJ0eXAiOiJKV1QiLCJhbGc...",
      "refresh_token": "def50200..."
    }
  }
}
```

**Errors:**
- `400 Bad Request` - Email ou senha n√£o fornecidos
- `401 Unauthorized` - Credenciais inv√°lidas
- `500 Internal Server Error` - Erro no servidor

#### 2. Refresh Token

```http
POST /api/auth/refresh
Content-Type: application/json

{
  "refresh_token": "def50200..."
}
```

**Response (200 OK):**
```json
{
  "success": true,
  "data": {
    "token_type": "Bearer",
    "expires_in": 31536000,
    "access_token": "eyJ0eXAiOiJKV1QiLCJhbGc...",
    "refresh_token": "def50200..."
  }
}
```

#### 3. Get User Info

```http
GET /api/auth/me
Authorization: Bearer {access_token}
```

**Response (200 OK):**
```json
{
  "success": true,
  "data": {
    "id": 1,
    "name": "Jo√£o Silva",
    "email": "user@example.com",
    "email_verified_at": "2024-01-01T00:00:00.000Z",
    "created_at": "2024-01-01T00:00:00.000Z",
    "updated_at": "2024-01-10T00:00:00.000Z"
  }
}
```

#### 4. Get User Profile

```http
GET /api/auth/profile
Authorization: Bearer {access_token}
```

**Response (200 OK):**
```json
{
  "success": true,
  "data": {
    // Perfil completo do usu√°rio
  }
}
```

#### 5. Validate Token

```http
POST /api/auth/validate
Authorization: Bearer {access_token}
```

**Response (200 OK):**
```json
{
  "success": true,
  "valid": true,
  "user": {
    "id": 1,
    "name": "Jo√£o Silva",
    "email": "user@example.com"
  }
}
```

#### 6. Logout

```http
POST /api/auth/logout
Authorization: Bearer {access_token}
```

**Response (200 OK):**
```json
{
  "success": true,
  "message": "Logout realizado com sucesso"
}
```

---

### SmileAI Platform Resources

#### 1. Get Documents

```http
GET /api/auth/smileai/documents
Authorization: Bearer {access_token}
```

**Response (200 OK):**
```json
{
  "success": true,
  "data": [
    // Lista de documentos do usu√°rio
  ]
}
```

#### 2. Get Chat Templates

```http
GET /api/auth/smileai/templates
Authorization: Bearer {access_token}
```

**Response (200 OK):**
```json
{
  "success": true,
  "data": [
    // Lista de templates de chat
  ]
}
```

#### 3. Get Brand Voice

```http
GET /api/auth/smileai/brand-voice
Authorization: Bearer {access_token}
```

**Response (200 OK):**
```json
{
  "success": true,
  "data": {
    // Configura√ß√µes de Brand Voice
  }
}
```

---

## üíª Uso no C√≥digo

### Backend - Proteger Rotas

```typescript
import { Router } from 'express';
import { smileaiAuthRequired } from '../middleware/smileaiAuth.js';

const router = Router();

// Rota protegida - requer autentica√ß√£o
router.get('/protected', smileaiAuthRequired, (req, res) => {
  // req.smileaiUser cont√©m os dados do usu√°rio
  // req.smileaiToken cont√©m o access token

  res.json({
    message: 'Acesso autorizado!',
    user: req.smileaiUser
  });
});

export default router;
```

### Backend - Autentica√ß√£o Opcional

```typescript
import { smileaiAuthOptional } from '../middleware/smileaiAuth.js';

// Rota p√∫blica com autentica√ß√£o opcional
router.get('/public', smileaiAuthOptional, (req, res) => {
  if (req.smileaiUser) {
    // Usu√°rio autenticado
    res.json({
      message: `Bem-vindo, ${req.smileaiUser.name}!`
    });
  } else {
    // Usu√°rio an√¥nimo
    res.json({
      message: 'Bem-vindo, visitante!'
    });
  }
});
```

### Backend - Verificar Roles

```typescript
import { smileaiAuthRequired, requireRole } from '../middleware/smileaiAuth.js';

// Apenas administradores
router.delete(
  '/admin/users/:id',
  smileaiAuthRequired,
  requireRole(['admin', 'super_admin']),
  (req, res) => {
    res.json({ message: 'Usu√°rio deletado' });
  }
);
```

### Frontend - Fazer Login

```typescript
// services/smileaiService.ts

export async function login(email: string, password: string) {
  const response = await fetch('http://localhost:3001/api/auth/login', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ email, password }),
  });

  const data = await response.json();

  if (data.success) {
    // Salvar token no localStorage
    localStorage.setItem('access_token', data.data.token.access_token);
    localStorage.setItem('refresh_token', data.data.token.refresh_token);
    localStorage.setItem('user', JSON.stringify(data.data.user));

    return data.data;
  } else {
    throw new Error(data.error);
  }
}
```

### Frontend - Fazer Requisi√ß√µes Autenticadas

```typescript
export async function fetchProtectedData() {
  const token = localStorage.getItem('access_token');

  const response = await fetch('http://localhost:3001/api/protected', {
    headers: {
      'Authorization': `Bearer ${token}`,
    },
  });

  const data = await response.json();
  return data;
}
```

### Frontend - Refresh Token Autom√°tico

```typescript
export async function refreshToken() {
  const refreshToken = localStorage.getItem('refresh_token');

  const response = await fetch('http://localhost:3001/api/auth/refresh', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ refresh_token: refreshToken }),
  });

  const data = await response.json();

  if (data.success) {
    localStorage.setItem('access_token', data.data.access_token);
    localStorage.setItem('refresh_token', data.data.refresh_token);
    return data.data.access_token;
  } else {
    // Token inv√°lido, fazer logout
    logout();
    throw new Error('Sess√£o expirada');
  }
}
```

---

## üîí Seguran√ßa

### Armazenamento de Tokens

**‚ö†Ô∏è IMPORTANTE: Nunca armazene tokens no c√≥digo ou logs!**

**Frontend (Recomenda√ß√µes):**
- ‚úÖ **localStorage** - F√°cil, mas vulner√°vel a XSS
- ‚úÖ **sessionStorage** - Mais seguro, perdido ao fechar aba
- ‚≠ê **httpOnly cookie** - RECOMENDADO (mais seguro)
- ‚ùå **C√≥digo JavaScript** - NUNCA!

**Backend:**
- ‚úÖ Tokens devem ser tratados como secrets
- ‚úÖ Nunca logar tokens completos
- ‚úÖ Usar HTTPS em produ√ß√£o
- ‚úÖ Validar tokens em cada requisi√ß√£o

### Rate Limiting

O servidor j√° possui rate limiting configurado:
- **Janela:** 15 minutos
- **M√°ximo:** 100 requisi√ß√µes por IP

Para ajustar, modifique `backend/.env`:
```env
RATE_LIMIT_WINDOW_MS=900000
RATE_LIMIT_MAX_REQUESTS=100
```

### CORS

Configure o frontend permitido em `backend/.env`:
```env
FRONTEND_URL=https://app.smileai.com.br
```

---

## üß™ Testes

### Testar Login

```bash
curl -X POST http://localhost:3001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"user@example.com","password":"senha123"}'
```

### Testar Rota Protegida

```bash
TOKEN="eyJ0eXAiOiJKV1QiLCJhbGc..."

curl http://localhost:3001/api/auth/me \
  -H "Authorization: Bearer $TOKEN"
```

### Testar Refresh Token

```bash
REFRESH_TOKEN="def50200..."

curl -X POST http://localhost:3001/api/auth/refresh \
  -H "Content-Type: application/json" \
  -d "{\"refresh_token\":\"$REFRESH_TOKEN\"}"
```

---

## üêõ Troubleshooting

### Erro: "Token de autentica√ß√£o n√£o fornecido"

**Causa:** Header `Authorization` n√£o foi enviado

**Solu√ß√£o:**
```javascript
headers: {
  'Authorization': `Bearer ${token}`
}
```

### Erro: "Token inv√°lido ou expirado"

**Causas:**
1. Token expirou
2. Token foi revogado (logout)
3. Token malformado

**Solu√ß√£o:**
1. Verificar validade do token
2. Usar refresh token para renovar
3. Fazer login novamente

### Erro: "CORS policy"

**Causa:** Frontend n√£o est√° na lista de origens permitidas

**Solu√ß√£o:**
1. Adicionar `FRONTEND_URL` ao `.env`
2. Reiniciar o servidor

### Erro: "Failed to connect to SmileAI"

**Causa:** SmileAI API offline ou URL incorreta

**Solu√ß√£o:**
1. Verificar `MAIN_DOMAIN_API` no `.env`
2. Testar manualmente: `curl https://smileai.com.br/api/user`
3. Verificar logs do backend

---

## üìä Logs

Todos os eventos de autentica√ß√£o s√£o logados:

```bash
# Ver logs em tempo real
tail -f backend/logs/app.log

# Filtrar por autentica√ß√£o
grep "SmileAI Auth" backend/logs/app.log
```

**Exemplos de logs:**
```
INFO: SmileAI: Password grant successful - email: user@example.com
INFO: SmileAI Auth: User authenticated - userId: 1, email: user@example.com
WARN: SmileAI Auth: Insufficient permissions - userId: 5, requiredRoles: ["admin"]
ERROR: SmileAI: Password grant failed - email: user@example.com, error: Invalid credentials
```

---

## üîÑ Fluxo de Autentica√ß√£o

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Frontend  ‚îÇ                                  ‚îÇ   Backend    ‚îÇ
‚îÇ  (Resea AI) ‚îÇ                                  ‚îÇ  (Resea AI)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
      ‚îÇ                                                  ‚îÇ
      ‚îÇ  1. POST /api/auth/login                       ‚îÇ
      ‚îÇ  { email, password }                            ‚îÇ
      ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
      ‚îÇ                                                  ‚îÇ
      ‚îÇ                                                  ‚îÇ  2. POST /oauth/token
      ‚îÇ                                                  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>
      ‚îÇ                                                  ‚îÇ  { grant_type, client_id,
      ‚îÇ                                                  ‚îÇ    client_secret, username,
      ‚îÇ                                                  ‚îÇ    password }
      ‚îÇ                                                  ‚îÇ
      ‚îÇ                                                  ‚îÇ  3. Response
      ‚îÇ                                                  ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
      ‚îÇ                                                  ‚îÇ  { access_token,
      ‚îÇ                                                  ‚îÇ    refresh_token }
      ‚îÇ                                                  ‚îÇ
      ‚îÇ                                                  ‚îÇ  4. GET /api/user
      ‚îÇ                                                  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>
      ‚îÇ                                                  ‚îÇ  Authorization: Bearer ...
      ‚îÇ                                                  ‚îÇ
      ‚îÇ                                                  ‚îÇ  5. Response
      ‚îÇ                                                  ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
      ‚îÇ  6. Response                                     ‚îÇ  { user data }
      ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
      ‚îÇ  { success, user, token }                       ‚îÇ
      ‚îÇ                                                  ‚îÇ
      ‚îÇ  7. Save tokens to localStorage                 ‚îÇ
      ‚îÇ                                                  ‚îÇ
      ‚îÇ  8. All subsequent requests                     ‚îÇ
      ‚îÇ  Authorization: Bearer {access_token}           ‚îÇ
      ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
      ‚îÇ                                                  ‚îÇ
```

---

## üìö Recursos Adicionais

- **Laravel Passport Docs:** https://laravel.com/docs/passport
- **OAuth 2.0 RFC:** https://oauth.net/2/
- **SmileAI API Docs:** https://smileai.com.br/docs

---

## ‚úÖ Checklist de Integra√ß√£o

### Backend
- [x] Configurar vari√°veis de ambiente (`.env`)
- [x] Importar rotas de autentica√ß√£o (`auth.ts`)
- [x] Adicionar middleware de autentica√ß√£o
- [x] Testar login via Postman/curl
- [x] Verificar logs de autentica√ß√£o
- [ ] Proteger rotas sens√≠veis com `smileaiAuthRequired`

### Frontend
- [ ] Criar servi√ßo de autentica√ß√£o (`smileaiService.ts`)
- [ ] Implementar tela de login
- [ ] Salvar tokens ap√≥s login
- [ ] Adicionar header `Authorization` nas requisi√ß√µes
- [ ] Implementar refresh token autom√°tico
- [ ] Implementar logout
- [ ] Tratar erros 401 (redirect para login)

### Deploy
- [ ] Configurar HTTPS (obrigat√≥rio para OAuth)
- [ ] Configurar CORS corretamente
- [ ] Verificar conectividade com SmileAI API
- [ ] Testar fluxo completo em produ√ß√£o
- [ ] Monitorar logs de autentica√ß√£o

---

**Data de Cria√ß√£o:** 2025-01-15
**Vers√£o:** 2.0.0
**Status:** ‚úÖ Completo e Testado
**Desenvolvedor:** Claude Code
